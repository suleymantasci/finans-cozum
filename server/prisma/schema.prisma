// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String?
  firstName     String?
  lastName      String?
  phone         String?
  birthDate     DateTime?
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  news          News[]
  favoriteNews  FavoriteNews[]
  favoriteMarkets FavoriteMarket[]
  favoriteTools FavoriteTool[]

  @@map("users")
}

model FavoriteNews {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  newsId    String
  news      News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, newsId])
  @@index([userId])
  @@index([newsId])
  @@map("favorite_news")
}

model FavoriteMarket {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol    String   // Örn: "USD/TRY", "BTC", "AKBNK"
  category  String   // "forex" | "crypto" | "stock" | "commodity"
  createdAt DateTime @default(now())

  @@unique([userId, symbol, category])
  @@index([userId])
  @@index([symbol, category])
  @@map("favorite_markets")
}

model FavoriteTool {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  toolId    String
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, toolId])
  @@index([userId])
  @@index([toolId])
  @@map("favorite_tools")
}

enum NewsStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  news News[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model News {
  id              String     @id @default(uuid())
  title           String
  slug            String     @unique // SEO-friendly URL slug
  excerpt         String?    @db.Text
  content         String     @db.Text // Rich text content (HTML)
  categoryId      String
  category        Category   @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  status          NewsStatus @default(DRAFT)
  featuredImage   String? // URL to uploaded image
  authorId        String
  author          User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tags            String[] // Array of tags
  metaTitle       String?
  metaDescription String?    @db.Text
  views           Int        @default(0)
  publishedAt     DateTime?
  scheduledAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  favoriteBy      FavoriteNews[]

  @@index([categoryId])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
  @@index([slug])
  @@map("news")
}

// ==================== NEWS ADS SYSTEM ====================

enum NewsAdSlotPosition {
  TOP           // Liste sayfasının üstünde
  BETWEEN_NEWS  // Haberler arasında (liste sayfasında)
  SIDEBAR_LEFT  // Sol sidebar (detay sayfasında)
  SIDEBAR_RIGHT // Sağ sidebar (detay sayfasında)
  AFTER_IMAGE   // Görsel sonrası (detay sayfasında)
  IN_CONTENT    // İçerik içinde (detay sayfasında)
  BOTTOM        // Sayfanın altında
}

model NewsAdSlot {
  id          String            @id @default(uuid())
  position    NewsAdSlotPosition
  isActive    Boolean           @default(true)
  order       Int               @default(0)

  // Reklam içeriği
  content     String?           @db.Text // HTML/JS reklam kodu
  scriptUrl   String?           // External script URL
  imageUrl    String?           // Reklam görseli
  linkUrl     String?           // Reklam linki

  // Görünürlük ayarları
  showOnMobile  Boolean         @default(true)
  showOnTablet  Boolean         @default(true)
  showOnDesktop Boolean         @default(true)

  // Tarih aralığı
  startDate   DateTime?
  endDate     DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([position])
  @@index([isActive])
  @@map("news_ad_slots")
}

// ==================== TOOLS SYSTEM ====================

enum ToolStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ToolDataSourceType {
  STATIC
  DATABASE
  EXTERNAL_API
}

enum AdSlotPosition {
  TOP
  SIDEBAR_LEFT
  SIDEBAR_RIGHT
  MIDDLE
  BOTTOM
  INLINE
}

enum SyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum SyncFrequency {
  HOURLY
  DAILY
  TWICE_DAILY
  FOUR_TIMES_DAILY
  CUSTOM
}

model ToolCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  order       Int     @default(0)
  isActive    Boolean @default(true)

  tools Tool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tool_categories")
}

model Tool {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  status      ToolStatus @default(DRAFT)

  // Component & Display
  component  String // Component name (e.g., "LoanCalculator", "CurrencyConverter")
  icon       String? // Lucide icon name
  color      String? // Theme color
  bgColor    String? // Background color
  order      Int     @default(0)
  isFeatured Boolean @default(false)

  // Data Source Configuration
  dataSourceType   ToolDataSourceType @default(STATIC)
  dataSourceConfig Json? // External API config, DB query config, etc.

  // Configuration (JSON)
  config Json? // Tool-specific config (default values, API endpoints, etc.)

  // SEO & Metadata
  metaTitle       String?
  metaDescription String?  @db.Text
  keywords        String[]

  // Analytics
  views Int @default(0)

  // Relations
  categoryId String?
  category   ToolCategory?  @relation(fields: [categoryId], references: [id])
  adSlots    ToolAdSlot[]
  dataSyncs  ToolDataSync[]
  favoritedBy FavoriteTool[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([isFeatured])
  @@index([dataSourceType])
  @@map("tools")
}

model AdSlotTemplate {
  id          String  @id @default(uuid())
  name        String  @unique
  description String? @db.Text

  position AdSlotPosition
  isActive Boolean        @default(true)

  // Reklam içeriği
  content   String? @db.Text
  scriptUrl String?
  imageUrl  String?
  linkUrl   String?

  // Görünürlük ayarları
  showOnMobile  Boolean @default(true)
  showOnTablet  Boolean @default(true)
  showOnDesktop Boolean @default(true)

  // Tarih aralığı
  startDate DateTime?
  endDate   DateTime?

  // Relations
  adSlots ToolAdSlot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([position])
  @@index([isActive])
  @@map("ad_slot_templates")
}

model ToolAdSlot {
  id     String  @id @default(uuid())
  toolId String?
  tool   Tool?   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Ortak reklam şablonu
  templateId String?
  template   AdSlotTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  position AdSlotPosition
  isActive Boolean        @default(true)
  order    Int            @default(0)

  // Reklam içeriği (Template'den override edilebilir)
  content   String? @db.Text
  scriptUrl String?
  imageUrl  String?
  linkUrl   String?

  // Görünürlük ayarları
  showOnMobile  Boolean @default(true)
  showOnTablet  Boolean @default(true)
  showOnDesktop Boolean @default(true)

  // Tarih aralığı
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([toolId])
  @@index([templateId])
  @@index([position])
  @@index([isActive])
  @@map("tool_ad_slots")
}

model ToolDataSync {
  id     String @id @default(uuid())
  toolId String
  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  name        String
  description String? @db.Text

  // External API Configuration
  apiUrl     String
  apiMethod  String @default("GET")
  apiHeaders Json?
  apiBody    Json?

  // Data Processing
  dataPath        String?
  transformScript String? @db.Text

  // Scheduling
  frequency      SyncFrequency @default(DAILY)
  cronExpression String?
  timezone       String        @default("Europe/Istanbul")

  // Status & Control
  isActive   Boolean    @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  lastStatus SyncStatus @default(PENDING)
  lastError  String?    @db.Text

  // Run History
  runCount     Int @default(0)
  successCount Int @default(0)
  failCount    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalData ExternalData[]

  @@index([toolId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("tool_data_syncs")
}

model ExternalData {
  id     String       @id @default(uuid())
  syncId String
  sync   ToolDataSync @relation(fields: [syncId], references: [id], onDelete: Cascade)

  // Data
  data     Json
  dataHash String?

  // Metadata
  source    String
  fetchedAt DateTime @default(now())

  @@index([syncId])
  @@index([source])
  @@index([fetchedAt])
  @@map("external_data")
}

// ==================== BIST MARKET DATA ====================

model BistDailyData {
  id            String   @id @default(uuid())
  symbol        String   // Hisse sembolü (örn: AKBNK)
  date          DateTime @db.Date // Tarih (sadece tarih, saat yok)
  
  // Fiyat Bilgileri
  price         Float    // Kapanış fiyatı
  open          Float    // Açılış fiyatı
  high          Float    // En yüksek
  low           Float    // En düşük
  prevClose     Float    // Önceki gün kapanış
  
  // Değişim
  change        Float    // Değişim miktarı
  changePercent Float    // Değişim yüzdesi
  
  // Hacim
  volume        Float    // Hacim (Lot)
  volumeTL      Float    // Hacim (TL)
  
  // Alış/Satış
  buy           Float?
  sell          Float?
  
  // BIST Grupları
  bistGroups    String[] // ['BIST', 'BIST 100', 'BIST 50', vb.]
  
  // Metadata
  lastTradeTime String?  // Son işlem saati
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
  @@index([symbol, date])
  @@map("bist_daily_data")
}

// ==================== TCMB FOREX DATA ====================

model TcmbDailyData {
  id            String   @id @default(uuid())
  date          DateTime @db.Date // Tarih (sadece tarih, saat yok)
  
  // Döviz Kurları (JSON formatında saklanacak)
  // Format: { "USD/TRY": { code: "USD", pair: "USD/TRY", name: "Amerikan Doları", price: 34.56, buy: 34.50, sell: 34.60 }, ... }
  forexData     Json     // Tüm döviz kurları
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([date])
  @@index([date])
  @@map("tcmb_daily_data")
}

// ==================== IPO (HALKA ARZ) DATA ====================

enum IpoStatus {
  UPCOMING      // Yaklaşan halka arz
  COMPLETED     // Sonuçlanmış halka arz
  DRAFT         // Taslak
}

model IpoListing {
  id              String      @id @default(uuid())
  bistCode        String      @unique // BIST kodu (örn: FRMPL, PAHOL) - unique identifier
  companyName     String      // Şirket adı
  ipoDate         String      // Halka arz tarihi (text format)
  detailUrl       String      // Detay sayfası URL
  logoUrl         String?     // Logo URL
  
  // Status Badges
  isNew           Boolean     @default(false) // il-new badge
  hasResults      Boolean     @default(false) // snc-badge (sonuçlar açıklandı)
  status          IpoStatus   @default(UPCOMING)
  
  // Relations
  detail          IpoDetail?
  results         IpoResult?
  applicationPlaces IpoApplicationPlace[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([bistCode])
  @@index([status])
  @@index([isNew])
  @@index([hasResults])
  @@map("ipo_listings")
}

model IpoDetail {
  id                    String      @id @default(uuid())
  listingId             String      @unique
  listing               IpoListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  // Basic Info (from sp-table)
  ipoDate               String?
  ipoDateTimeRange      String?     // Saat aralığı (örn: 09:00-17:00)
  ipoPrice              String?     // Halka arz fiyatı/aralığı
  distributionMethod    String?     // Dağıtım yöntemi
  shareAmount           String?     // Pay miktarı
  intermediary          String?     // Aracı kurum
  consortium            String[]    // Konsorsiyum üyeleri
  actualCirculation     String?     // Fiili dolaşımdaki pay (for completed)
  actualCirculationPct  String?     // Fiili dolaşımdaki pay oranı
  firstTradeDate        String?     // BIST ilk işlem tarihi
  market                String?     // Pazar (Ana Pazar, Yıldız Pazar, etc.)
  
  // Summary Info (Özet Bilgiler) - stored as JSON
  summaryInfo           Json?       // Halka arz şekli, fon kullanımı, tahsisat grupları, etc.
  
  // Company Info
  companyDescription    String?     @db.Text
  city                  String?
  foundedDate           String?
  
  // Attachments (Ekler) - stored as JSON array
  attachments           Json?       // PDF links
  
  lastModified          String?     // Son güncelleme tarihi
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([listingId])
  @@map("ipo_details")
}

model IpoResult {
  id                String      @id @default(uuid())
  listingId         String      @unique
  listing           IpoListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  // Results Table Data (as-table)
  resultsData       Json        // Yatırımcı grubu, kişi sayısı, lot, oran
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([listingId])
  @@map("ipo_results")
}

model IpoApplicationPlace {
  id                String      @id @default(uuid())
  listingId         String
  listing           IpoListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  name              String      // Kurum adı
  isConsortium      Boolean     @default(false) // Konsorsiyum üyesi mi
  isUnlisted        Boolean     @default(false) // unlist class'ı var mı
  
  createdAt         DateTime    @default(now())
  
  @@index([listingId])
  @@map("ipo_application_places")
}

// ==================== COMMODITY (ALTIN) DAILY DATA ====================

model CommodityDailyData {
  id            String   @id @default(uuid())
  date          DateTime @db.Date // Tarih (sadece tarih, saat yok)
  hour          Int      // Saat (0-23) - saat başı kayıt için
  
  // Altın verileri (JSON formatında saklanacak)
  // Format: MarketDataItem[] array
  commodityData Json     // Tüm altın/gümüş/platin fiyatları
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([date, hour], name: "date_hour")
  @@index([date])
  @@index([date, hour])
  @@map("commodity_daily_data")
}
